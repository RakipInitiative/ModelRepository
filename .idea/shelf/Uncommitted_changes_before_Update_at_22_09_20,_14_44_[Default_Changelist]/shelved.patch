Index: README.md
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+># ModelRepository\nJoint project of EFSA, Federal Institute For Risk Assessment, DTU and ANSES to create an online model repository.\n\n# content\n## Nauta EFSA opinion\n### Reference\nhttps://efsa.onlinelibrary.wiley.com/doi/full/10.2903/j.efsa.2020.6090 \n\n## Lindqvist EFSA opinion\n### Reference \ndoi: 10.2903/j.efsa.2020.6092\n\n## plan for next days\n\n\n### 18/09\n* jukka microbial criterion model\n  * transfer R code to fskx\n  * general functionality with openBUGS? on server?\n  * annotate\n\n\n### 17/09\n* nauta\n  * 3 example models CPM/DRM combinations\n    * copy&paste R code into fskx\n    * test functionality\n    * annotate\n    * test on server\n\n\n### done so far\n\n### 10/09\n* lindqvist Listeria\n  * visualisation -> table as in results2.xlsx ... DONE\n  * output of xlsx -> remove ... DONE\n  * contact lindqvist with Maarten in cc for support ... DONE\n  * test on server: ... DONE\n    * check which packages are needed after rewrite of code ... DONE\n    * tell Lars which packages need to be installed ... DONE\n\n\n\n\n#### 09/09\n\n    * rewrite code for fskx transformation ... DONE\n      * rewrite m.g.QMRA.R as function inside master.R script\n    * Define input parameters ... DONE\n      * number of runs\n      * population group\n\n\n\n\n#### 08/09\n  * nauta efsa opinion\n    * review and test of all CPMs, DRMs and RRM fskx files (execution and annotation) ... in progress\n      * adapting DRM module versions with explanation ... in progress\n    * test CPMs on server ... DONE\n    * implement Maartens comments ... in progress\n      * table for quantile results as an optional visualisation ... DONE\n        * insert title (CPM/DRM/MS) ... DONE\n        * transform probabilities into percentage values with 1 decimal ... DONE\n      * random CPM/DRM combination (for every MC iteration, may need to restructure code) ... REJECTED (until further notice)\n  * lindqvist Listeria\n    * analysed R code ... DONE\n    * test run ... DONE, success\n    * rewrite code for fskx transformation ... in progress\n      * rewrite m.g.QMRA.R as function inside master.R script\n      * Define input parameters\n        * number of runs\n        * population group\n      * visualisation -> table as in results2.xlsx\n      * output of xlsx -> remove\n      * test on server: \n        * check which packages are needed after rewrite of code\n        * tell Lars which packages need to be installed\n\n\n#### 31/08 - 01/09\n  * review and test of all CPMs, DRMs and RRM fskx files (execution and annotation) ... in progress\n    * CPMs insert author list ... DONE\n    * CPMonly versions? remove unnecessary input/output parameters ... REJECTED\n    * DRMs insert author list ... DONE\n    * adapting DRM module versions with explanation ... in progress\n    * RRM insert author list\n  * test CPMs on server as soon as CPM is ready to be tested ... in progress\n    * DRMs can be uploaded and run properly, but encounters problems in FSK-Web, all models run on server\n  * implement Maartens comments ... in progress\n    * table for quantile results as an optional visualisation\n      * insert title (CPM/DRM/MS)\n      * transform probabilities into percentage values with 1 decimal\n    * random CPM/DRM combination (for every MC iteration, may need to restructure code)\n\n\n##### 28/08\n  * distribute new visualisation code to all CPMs and DRMs ... in progress\n    * finishing CPMs ... DONE\n    * finishing DRMs ... in progress\n      * creating DRMonly versions ... DONE\n      * adapting DRM module versions with explanation: low priority since joiner doesnt work properly\n    * finishing RRM ... in progress\n      * visualisation errorbars ... DONE\n      * random CPM/DRM/MS... DONE\n      * test in FSK-Lab ... DONE\n  * test CPMs on server as soon as CPM is ready to be tested ... pending, waiting for developers\n  * finalise RRM annotation (need some input see below) ... DONE\n  * fix a number of known errors in CPM/DRM annotation ... DONE\n  * review and test of all CPMs, DRMs and RRM fskx files (execution and annotation) ... in progress\n    * CPMs ... DONE\n    * DRMs ... pending, waiting for Petras review\n    * RRM ... DONE\n  * create a few example CPM/DRM combination as fskx models ... in progress\n\n##### 27/08\n  * distribute new visualisation code to all CPMs and DRMs ... in progress\n    * finishing CPMs ... in progress\n    * finishing DRMs ... in progress\n      * creating DRMonly versions ... in progress\n      * adapting DRM module versions with explanation: low priority since joiner doesnt work properly\n    * finishing RRM ... in progress\n      * visualisation errorbars\n      * random CPM/DRM/MS\n      * test in FSK-Lab \n  * test CPMs on server as soon as CPM is ready to be tested ... pending, waiting for developers\n  * finalise RRM annotation (need some input see below) ... in progress\n  * fix a number of known errors in CPM/DRM annotation ... DONE\n  * review and test of all CPMs, DRMs and RRM fskx files (execution and annotation) ... in progress\n    * CPMs ... in progress\n    * DRMs ... pending, waiting for Petras review\n    * RRM ... in progress\n  * create a few example CPM/DRM combination as fskx models\n\n\n##### 26/08\n  * distribute new visualisation code to all CPMs and DRMs ... in progress\n    * finishing CPMs ... DONE\n    * finishing DRMs ... pending, waiting for Maartens comments\n    * finishing RRM ... pending, waiting for Maartens comments\n   * test CPMs on server as soon as CPM is ready to be tested ... pending, waiting for developres\n  * finalise RRM annotation (need some input see below) ... in progress\n  * fix a number of known errors in CPM/DRM annotation ... DONE\n  * review and test of all CPMs, DRMs and RRM fskx files (execution and annotation) ... in progress\n  * create a few example CPM/DRM combination as fskx models\n\n##### 25/08\n  * clean up R code ... in progress\n    * CPMs ... DONE\n    * DRMs ... DONE\n    * RRM ... DONE\n  * distribute new visualisation code to all CPMs and DRMs ... in progress\n    * finishing CPMs ... DONE\n    * finishing DRMs ... pending, waiting for Maartens comments\n    * finishing RRM ... pending, waiting for Maartens comments\n  * cleaning up obsolete code snippets and output parameters to increase transparency ... DONE\n  * test CPMs on server as soon as CPM is ready to be tested ... not possible at the moment, Thomas is investigating\n  * finalise RRM annotation (need some input see below) ... in progress\n  * fix a number of known errors in CPM/DRM annotation\n\n\n##### 24/08\n  * clean up R code ... in progress\n    * CPMs ... DONE\n  * distribute new visualisation code to all CPMs and DRMs ... in progress\n    * finishing CPMs ... mostly done, mylius missing\n  * cleaning up obsolete code snippets and output parameters to increase transparency\n  * test CPMs on server as soon as CPM is ready to be tested ... in progress, stuck at uploading -> asking Lars/Thomas for help\n\n##### 21/08\n  * implement visualisation fixes for CPMs \n    * find out about reason for steplike function at low doses ... DONE\n    * fix cdf should increase to 1 ... DONE\n  * implement visualisation fixes for DRMs ... DONE\n  * implement visualisation with all reduction (or \"intervention\") scenarios ... DONE\n  * implement RRM standalone fskx model with all 24 CPM/DRM-combinations as a csv table input and have the user choose CPM and DRM as input parameter ... DONE\n\n\n\n\n\n\n\n\n### Questions for Maarten - call 2\n  * visualisation of CPM ... fine, according to Maarten, confirmation?\n    * Maarten:  d\n  * visualisation of DRM -> changes, more infos?\n    * Maarten: \n  * visualisation of RRM\n    * may show all intervention scenarios at the same time (load from table) = same vis as in @Risk -> better?\n    * IF ONLY one intervention scenario: should the name (FA1/2/3...) be put into visualisation?\n    * which text infos in visualisation?\n    * Maarten: all intervention plus one from user\n  * annotation of RRM:\n    * Inputs from MS skin results\n       * definition?\n       * how to annotate?\n       * EU values are weighted average of all MS, here is just taken as input value, not calculated -> problem?\n    * meat conc distributions Input scale (CFU skin) as parameter or leave it as is? how to annotate?\n    * slope - definition? or where to find\n    * tau - definition? or where to find\n    * delta fex - definition? or where to find\n  \n\n\n### Questions for Maarten - call 1\n#### general questions model related\n  * Cret in R code is randomly chosen (normal distribution), in @Risk as abscissa with certain range for Pill\n    * -> new model?s \n    * Maarten: OK\n  * new visualisation dose vs cret --> possible to simulate the other plot, sampling from Cret-axis and get dose distribution\n    * possible to recreate old visualization -> would that be better? \n    * Maarten: YES\n    * (current visualization RAKIP models: what is ordinate? what is info i get out of it?) Distribution given Cret\n  * Maxportion in RAKIP = 1000, but in @Risk no upper bound is given... what to do? \n    * Maarten: take Maxportion = 1000\n  * in R models is Prev (probability of prevalence) used --> also for efsa opinion relevant? \n    * Maarten: use it in code as is\n  * dose in RAKIP models only binomial distribution, dose in @Risk model is normal -> which one ? \n    * Maarten: BOTH (for either case)\n\n#### specific CPM related questions\n  * Lindqvist: Ncarcass vs Nportion? \n    * Maarten: summ Nportion to Ncarcass (1097 average carcass size)\n  * Van Asselt: washed board prob =0, but unwashed board depends on hands => shouldnt washed board with unwashed hands do something? \n    * Maarten: its ok\n  * calistri model: empiric transfer probability hands to meat 2x 0.6? is that correct? its a cdf, isnt it? \n    * Maarten: Mistake;\n    * Marcel checked in paper: 0.8 is correct, corrected in R code, but differences are minor <1%\n\n#### regression model questions\n  *  in Campy regression @Risk code in tab \"meat conc distributions\", column log dose interval : first and last values weird source cell in excel -> better? \n    * Maarten: reason is matching pattern in delta -> Marcel simulates this in R code (even if changes would be minor)\n \n\n### general R problems\n  * R 3.X: some functions(rbinom, gamma, etc.) have only a 32bit range of numbers --> some models use numbers outside of 32bit range - solved in R4 but FSK only supports R3.X\n\n#### Christensen et al.: Risk Assessment of Campylobacter jejuni in Chicken Products\n##### status\n  * found fskx file in RAKIP model repository, not fully annotated, discrepancies between code and reference\n  * refers to DOI: 10.1111/j.1539-6924.2010.01481.x --> checking that reference led to similar publication\n##### todo\n  * need to check if model code and code in reference are identical\n  * annotation completing  \n##### Reference\nChristensen B, Sommer H, Nielsen N and Rosenquist H, 2001. Risk Assessment of Campylobacter jejuni in Chicken\nProducts. Danish Veterinary and Food Administration, Copenhagen, Denmark.\n\n\n#### Brynestad et al.: Quantitative microbiological risk assessment of campylobacteriosis cases in the German population due to consumption of chicken prepared in homes\n##### status\n  * found fskx file in RAKIP model repository, not fully annotated, discrepancies between code and reference\n  * refers to DOI: 10.1111/j.1539-6924.2010.01481.x --> checking that reference led to similar publication\n##### todo\n  * need to check if model code and code in reference are identical\n  * annotation completing  \n##### Reference\nBrynestad S, Braute L, Luber P and Bartelt E, 2008. Quantitative microbiological risk assessment of\ncampylobacteriosis cases in the German population due to consumption of chicken prepared in homes.\nInternational Journal of Risk Assessment and Management, 8, 194–213\n\n\n\n#### Nauta et al.: Food safety in the domestic environment: the effect of consumer risk information on human disease risks\n##### status\n  * found fskx file in RAKIP model repository, not fully annotated, discrepancies between code and reference\n  * refers to DOI: 10.1111/j.1539-6924.2010.01481.x --> checking that reference led to DIFFERENT publication\n##### todo\n  * need to check if model code and code in reference are identical\n  * annotation completing  \n##### Reference\nNauta MJ, Fischer AR, van Asselt ED, de Jong AE, Frewer LJ and de Jonge R, 2008. Food safety in the domestic\nenvironment: the effect of consumer risk information on human disease risks. Risk Analysis, 28, 179–192.\n\n\n\n#### WHO: Risk assessment of Campylobacter spp. in broiler chickens: technical report\n##### status\n  * found fskx file in RAKIP model repository, not fully annotated, discrepancies between code and reference\n  * refers to DOI: 10.1111/j.1539-6924.2010.01481.x --> checking that reference led to DIFFERENT publication\n##### todo\n  * need to check if model code and code in reference are identical\n  * annotation completing  \n##### Reference\nWHO, 2009. Risk assessment of Campylobacter spp. in broiler chickens: technical report. Microbiological Risk\nAssessment Series, 12 \n\n### CPMs currently in process of transfer to fskx\n\n#### Mylius et al.: Cross-contamination during food preparation: a mechanistic modelapplied to chicken-borne Campylobacter\n##### Reference\nMylius SD, Nauta MJ and Havelaar AH, 2007. Cross-contamination during food preparation: a mechanistic model\napplied to chicken-borne Campylobacter. Risk Analysis, 27, 803–813.\n\n\n\n#### van Asselt et al.: Cross-contamination in the kitchen: estimation of transfer rates for cutting boards, hands and knives\n##### Reference\nvan Asselt ED, de Jong AE, de Jonge R and Nauta MJ, 2008. Cross-contamination in the kitchen: estimation of\ntransfer rates for cutting boards, hands and knives. Journal of Applied Microbiology, 105, 1392–1401.\n\n\n\n#### Calistri and Giovannini: Quantitative risk assessment of human campylobacteriosis related to the consumption of chicken meat in two Italian regions\n##### Reference\nCalistri P and Giovannini A, 2008. Quantitative risk assessment of human campylobacteriosis related to the\nconsumption of chicken meat in two Italian regions. International Journal of Food Microbiology, 128, 274–287.\n\n\n\n#### Lindqvist and Lindblad: Quantitative risk assessment of thermophilic Campylobacter spp. and crosscontamination during handling of raw broiler chickens evaluating strategies at the producer level to reduce human campylobacteriosis in Sweden\n##### Reference\nLindqvist R and Lindblad M, 2008. Quantitative risk assessment of thermophilic Campylobacter spp. and crosscontamination during handling of raw broiler chickens evaluating strategies at the producer level to reduce\nhuman campylobacteriosis in Sweden. International Journal of Food Microbiology, 121, 41–52.\n\n\n\n\n### DRM\n3 dose response models are compared to each other\n\n\n## Jukka Ranta models\n### Jukka Ranta et al.: unnamed Dose response model\n\n### Jukka Ranta et al.: A Bayesian approach to the evaluation of risk-based microbiological criteria for Campylobacter in broiler meat\nhttps://projecteuclid.org/download/pdfview_1/euclid.aoas/1446488745\n\n\n\n# outlook\n## EFSA /  Lindqvist et al.: mgQMRA Listeria monocytogenes in frozen fruit, vegetables and herbs\n##### Reference\nhttps://www.efsa.europa.eu/en/efsajournal/pub/6092\n\n\n## Meester / Swart et al.: A quantitative risk assessment for human Taenia solium exposure from home slaughtered pigs in European countries\n\n## Deng / Swart et al: Quantitative risk assessment of meat-borne Toxoplasma gondii infection in the mainland of China\n\n## Swart et al:  A quantitative risk model for Trichinella spp. in pork and wild boar meat\n\n## Teunis et al:  Acute illness from Campylobacter jejuni may require high doses while infection occurs at low doses\n\n## Source attribution models (microbial subtyping for salmonellosis) – work funded by MATRIX project\n##### Reference\nhttps://onlinelibrary.wiley.com/doi/full/10.1111/zph.12645\n\n## EFSA: tubs model → certain elements might be possible (growth model) KJ \n\n## Other ideas\n\n  * https://www.sciencedirect.com/science/article/abs/pii/S0360132320303292\n  * Campylobacter DRM: https://onlinelibrary.wiley.com/doi/full/10.1111/risa.12572
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- README.md	(revision b9eda22f2c445e7b5804430a59263cf548c7f211)
+++ README.md	(date 1600416625643)
@@ -12,14 +12,12 @@
 
 ## plan for next days
 
-
 ### 18/09
 * jukka microbial criterion model
   * transfer R code to fskx
   * general functionality with openBUGS? on server?
   * annotate
 
-
 ### 17/09
 * nauta
   * 3 example models CPM/DRM combinations
@@ -28,7 +26,6 @@
     * annotate
     * test on server
 
-
 ### done so far
 
 ### 10/09
Index: lindqvist_list/newversion/lindqvist20.r
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>#############################\n# Input Parameters\n#############################\nsims = 250#The number of simulations of script mgQMRA \npop=11 #11 is females and 12 is males, age group 65-74 years old\nruns= 200000 #Define the number of iterations to run the script\n\n#############################\n# Model Script\n#############################\n###########################################\n#Libraries used in the script\nlibrary(readr)\nlibrary(readxl)\nlibrary(msm)\nlibrary(tidyverse)\nlibrary(plotly)\nlibrary(mc2d)\nlibrary(knitr)\nlibrary(ggplot2)\nlibrary(readr)\nlibrary(dplyr)\nlibrary(xlsx)\nlibrary(Matrix)\n\nset.seed(3333) #Arbitrary number but should be set so differences are due only to differencs in input data\n\n##########################################\n# imported script\n\n\n  ##Simplified gQMRA script: with the purpose of addding frozen food as heat treated or RTE, \n  #extract results per food sucategory and evaluating only for one population at th time. \n  #The possibility of inlcuding a simple heating step, log reduction is included. Risk is calculated \n  #directly per food subcagegory, not for whole dose distributions per population. \n  #This differes from teh original scipt, otherswise the same code and input data is used\n  #This script is run from the  master script to eanlbe multiple simulations\n  \n  #User defined data to change in this script are:\n  #the name and data in the input data file. Input data can be changed to evalauate uncertainty\n  #the number of the population to be evaluated - defined in input data\n  #The prevalence estimate to be used for frozen vegetables - to evalaute uncertainty of this parameter\n\n\n\n  #################################################\n  #Extract input data to xfile\n  #################################################\n  xfile=\"~/Projects/ModelRepository/lindqvist_list/originalfiles/input.data.xlsx\"\n  prev=read_excel(xfile,sheet=\"prev\", col_names=TRUE)\n  conc=read_excel(xfile,sheet=\"conc\", col_names=TRUE)\n  EGR=read_excel(xfile,sheet=\"EGR\", col_names=TRUE)\n  ROP=read_excel(xfile,sheet=\"ROP\", col_names=TRUE)\n  DRP=read_excel(xfile,sheet=\"DR\", col_names=TRUE)\n  conso=read_excel(xfile,sheet=\"conso\", col_names=TRUE)\n  size=read_excel(xfile,sheet=\"size\", col_names=TRUE)\n  r_time=read_excel(xfile,sheet=\"r_time\", col_names=TRUE)\n  log_red=read_excel(xfile,sheet=\"log_red\", col_names=TRUE) #Log reduction beta-pert disribution\n\n  \nmodelPill_out <- function(sims, pop, runs,\n                          prev, conc, EGR, ROP, DRP, conso, size, r_time, log_red){\n  #################################################\n  #################################################\n  #Definition of functions needed\n  #################################################\n\n  \n  pop.group <- DRP[pop,1:2]\n  pop.group\n\n  #Convert mean and variance of Y to \n  #mean and std of log(Y) - to use rtnorm to get lognorm, later backtransformed in EGR5\n  convert_m_v=function(m,v){\n    phi = sqrt(v + m^2)\n    mu=log(m^2/phi) #mean of log(Y)  \n    sigma = sqrt(log(phi^2/m^2))#\n    c(mu,sigma)\n  }\n  #Primary growth model\n  rosso=function(time,egrm,lag=0,x0,xmax){ \n    x0=10^x0 \n    xmax=10^xmax\n    den=1+(xmax/x0 -1)*exp(-egrm*(time-lag))\n    log10(xmax/den)\n  } \n  #################################################\n  #################################################\n  ####Start of the definition of contamfunc\n  ####shift is argument that shifts the xmax (maximum population density)\n  ### meanTemp and sdTemp are the parameters of the normal distribution of \n  ###the consumer refrigerators\n  ###Mode_prop_rtime and Max_prop_rtime are respectively the mode and the maximum of the proportion \n  ###of the shelflife used as time of storage\n  ###runs is the number of iterations\n  contamfun=function(runs,shift=0,meanTemp=5.9,\n                     sdTemp=2.9,\n                     Mode_prop_rtime=0.3,\n                     Max_prop_rtime=1.1) {\n    ######################################\n    #Initial concentration for each\n    #of the 15 RTE subcategories\n    ######################################\n    C0fun=function(i) rbetagen(runs, \n                               shape1=conc$shape1[i], \n                               shape2=conc$shape2[i], \n                               min=conc$min[i],  \n                               max=conc$max[i]+shift) \n    #the function C0fun is applied to each of the fifteen\n    #food categories thanks to sapply\n    C0r=sapply(1:nrow(conc),C0fun)\n    #C0r is a matrix with a number of lines equal to runs\n    #and a number of columns eaqual to the number of food categories\n    #dimension is runs x 15\n    ######################################\n    #Exponential Growth Rate\n    #for each of the 15 food subcategories\n    ######################################\n    \n    EGR5fun=function(i){\n      m=EGR$m[i]\n      s=EGR$sd[i]\n      parm=convert_m_v(m,s^2)\n      rtnorm(runs,mean=parm[1],sd=parm[2],\n             lower=log(EGR$min[i]),upper=log(EGR$max[i])) \n    }\n    \n    EGR5r=exp(sapply(1:nrow(conc),EGR5fun))\n    #dimension of EGR5r is runs x 15\n    ######################################\n    #Refrigerator Temperature\n    #EGR\n    ######################################\n    \n    Tempr=rtnorm(runs,mean=meanTemp,sd=sdTemp,\n                 lower=-2,upper=15)\n    #dimension of Tempr is runs x 1\n    Tmin=-1.18\n    EGRr=EGR5r*((Tempr-Tmin)/(5-Tmin))^2\n    EGRr[Tempr<Tmin]<-0\n    \n    #dimension of EGRr is runs x 15\n    ######################################\n    #Time of storage\n    #\n    ######################################\n    \n    ##########\n    #remaining shelf life\n    ##########\n    r_timefun=function(i){\n      m=r_time$m[i]\n      pmin(rexp(runs,rate=1/m), r_time$max[i])\n    }\n    r_timer=sapply(1:length(unique(r_time$group)),r_timefun)\n    #dimension of r_timer is runs x 15\n    #########\n    #Proportion of r_time\n    #########\n    \n    propr=rpert(runs, min=0, mode=Mode_prop_rtime, max=Max_prop_rtime)\n    #dimension of propr is runs x 1\n    #########\n    #s_time\n    #########\n    s_time=r_timer*propr\n    #dimension of s_time runs x 15\n    \n    #########################################################\n    #function describing heat inactivation (log reduction) \n    #during cooking (frozen vegetables)\n    #fraction described by ROP in file for frozen vegetables\n    #########################################################\n    \n    LRD=function(i) {\n      reds <- f_concr[,i] - rpert(runs, min=log_red$min[i], mode=log_red$mode[i], max=log_red$max[i])\n    }\n    #Dimension is runs x 15\n    \n    \n    ######################################\n    #Concentration at time of consumption\n    #f_conc\n    ######################################\n    f_concfun=function(i){\n      Nmax=EGR$Nmax.mean[i]+shift\n      rosso(s_time[,i],EGRr[,i],C0r[,i],lag=0,Nmax)\n    }\n    f_concr=sapply(1:length(unique(r_time$group)),f_concfun)\n    ff_concr= sapply(1:length(unique(r_time$group)), LRD)\n    #return(ff_concr)\n  }\n  \n  #test of output\n  resc=contamfun(runs=runs,shift=0,meanTemp=5.9,\n                 sdTemp=2.9,\n                 Mode_prop_rtime=0.3,\n                 Max_prop_rtime=1.1)\n  \n  #simulated log contamination per food category\n  ###head(resc) #run if want to inspect if reasonable output\n  \n  #simulated log dose per food category\n  sim.dose <- function(runs, contam, pop){\n    ss <- log10(as.numeric(as.vector(t(size[pop, 3:ncol(size)]))))\n    dose <- ss + contam\n  } \n  \n  dose <- sim.dose(runs=runs, contam=resc, pop=pop)\n  \n  #Stochastic dose response model as in Pouillot et al. (2015)\n  sims.risk <- function(runs, dose, pop){\n    m=DRP$Mean[pop]\n    sd= DRP$RefSdLog[pop]\n    rlog=rnorm(runs,m,sd)\n    r <- 10^rlog\n    Pill_cont <- 1 - exp(-r*10^dose)\n    return(Pill_cont)\n  }\n  \n  #Predicted probability of illness per contaminated serving\n  Pill_cont <- sims.risk(runs=runs, dose=dose, pop=pop)\n  \n  #Prevalence of contaminated servings - uncertainty. In the baseline here and for the \n  #other RTE foods the mean prevalence is used\n  p_beta <- prev$N[]- prev$S[] + 1\n  p_alfa <- prev$S[] + 1\n  prev_group <- replicate(1000, rbeta(length(p_alfa), p_alfa[], p_beta[]))\n  prev_group.means <- rowMeans(prev_group)\n  prev_fgroup <- replicate(runs, prev_group.means) #Baseline run - leave in all the time\n  \n  #Prevalence of contaminated frozen vegetables servings - uncertainty. Edit and run \n  #relevant lines below if uncertainty of the prevalence is to be evaluated \n  #(best, probs=0.025, or worst case, probs=0.975).group 7 is frozen vegetables as RTE,\n  #and 15 cooked frozen vegetables. Se input data table \n  \n  #Edit (best or worst and group 7 and 15) and run appropriate next four lines to evalaute\n  #uncertainty of prevalence\n  #scen.prev <- quantile(prev_group[7,],probs=0.025 or 0.975) #Prevalence best case scenario \n  #scen.prev <- quantile(prev_group[15,],probs=0.025 or 0.975) #Prevalence worst case scenario\n  \n  #Replace prevalence of frozen vegetables with the best or worst case estimate\n  #prev_fgroup[7,] <- replicate(runs, scen.prev) #If uncertainty scenario leave\n  #prev_fgroup[15,] <- replicate(runs, scen.prev) #If uncertainty scenario leave\n  \n  #The prevalence of the different food sub categories used in the simulation\n  prev_fdgroup <- t(prev_fgroup) \n  \n  #Probability of illness per any serving for each foodgroup\n  Pill <- Pill_cont * prev_fdgroup\n  P_pserv <- data.frame(Pill)\n  colnames(P_pserv) <- c(\"csfR\",\"hsfR\",\"grfR\",\"come\",\"sausR\",\"pateR\",\"fvR\",\"csf\",\"hsf\",\"grf\",\"comeR\",\"saus\",\"pate\",\"sssch\",\"fvco\")                     \n  \n  #P_pserv #Run only if want to inspect results\n  \n  #Distribution of probability of illness per serving per food group\n  perc_quant <- function(x) {\n    quantile(x, probs = c(0, 0.025, 0.5, 0.975, 1))\n  } \n  \n  pserv_mean <- t(sapply(P_pserv, mean))\n  pserv_sd <- t(sapply(P_pserv, sd))\n  Pserv_res <- as.data.frame(t(sapply(P_pserv, perc_quant)))\n  Pserv_res$mean <- as.vector(pserv_mean)\n  Pserv_res$sd <- as.vector(pserv_sd)\n  \n  #Summary of result, probability of illness per serving\n  Pserv_res\n  rname <- c(\"csfR\",\"hsfR\",\"grfR\",\"come\",\"sausR\",\"pateR\",\"fvR\",\"csf\",\"hsf\",\"grf\",\"comeR\",\"saus\",\"pate\",\"sssch\",\"fvco\")\n  \n  Pserv_mean <-Pserv_res$mean\n  Pill_mean <- data.frame(x=Pserv_res$mean, y=rname)\n  colnames(Pill_mean) <- c(\"mean.Pill.serving\", \"food.group\")\n  \n  return(list(Pill_mean=Pill_mean[,1]))\n}  \n  \n# imported script\n##############################################\n\n\nPill_out <- lapply(1:sims,modelPill_out,\n                   pop=pop,runs=runs,\n                   prev=prev, conc=conc, EGR=EGR, ROP=ROP, \n                   DRP=DRP, conso=conso, size=size, \n                   r_time=r_time, log_red=log_red)\n#Pill_out <- Pill_test$Pill_mean[,1]\n#<- lapply(1:sims, function(n)source(\"~/Projects/ModelRepository/lindqvist_list/originalfiles/m.g.QMRA.R\")$value[,1])\n\n\n\n\n\nPill_out #Probability of illness per serving\nPill_df<- data.frame(matrix(unlist(Pill_out), ncol=length(Pill_out), byrow=F))\n\nPill_df <- data.frame(t(Pill_df))\ncolnames(Pill_df) <- c(\"csfR\",\"hsfR\",\"grfR\",\"come\",\"sausR\",\"pateR\",\"fvR\",\"csf\",\"hsf\",\"grf\",\"comeR\",\"saus\",\"pate\",\"sssch\",\"fvco\")\nPill_df #Data frame with the probability of illness per serving per simulation per food subcategory\n\n#Write the mean probability of illness per serving for the food_category for each simulation \n#write.xlsx(Pill_df, \"results.xlsx\", sheetName=\"scenario_name\", append=TRUE)\n\n#Description of the outcome of the 250 simulations per food category\nperc_quant <- function(x) {\n  quantile(x, probs = c(0.025, 0.5, 0.975))\n}\n\nPserv_res <- as.data.frame(sapply(Pill_df[, 1:15], perc_quant)) #15 food subcategories\n\nPserv_res\n\npserv_mean <- sapply(Pill_df[, 1:15], mean)\npserv_sd <- sapply(Pill_df[, 1:15], sd)\n\nPserv_res <- rbind(Pserv_res, mean=pserv_mean)\nPserv_res <- rbind(Pserv_res, sd=pserv_sd)\nPserv_res\n\n###Ranking based on the mean probability per serving\npop.group <- DRP[pop,1:2] #population according to indata.file (65-74, females=11, 65-74, males=12)\n\n#Ranking based on mean probability of illness per serving\nPill <- as.data.frame(t(Pserv_res))\nPill_mean_r <- Pill[order(-Pill$mean),]\nPill_mean_r\n\n#Write rankings of the food subcateregories based on the mean probability of illness per serving \n#write.xlsx(Pill_mean_r, \"results2.xlsx\", sheetName=\"scenario_name\", append=TRUE)\n\n\n#############################\n# Visualisation Script\n#############################\n\nlibrary(gridExtra)\nlibrary(gridGraphics)\nlibrary(gtable)\n\nmytheme <- gridExtra::ttheme_default(\n  core = list(fg_params=list(cex = 0.7)),\n  colhead = list(fg_params=list(cex = 1.0)),\n  rowhead = list(fg_params=list(cex = 1.0)))\n\n\nmyt <- gridExtra::tableGrob(Pill_mean_r, theme = mytheme)\ntitle <- textGrob(\"Your title here\", gp = gpar(fontsize = 15))\npadding <- unit(0.5,\"line\")\ntable <- gtable_add_rows(\n  myt, heights = grobHeight(title) + padding, pos = 0\n)\ntable <- gtable_add_grob(\n  table, list(title),\n  t = 1, l = 1, r = ncol(table)\n)\nframe()\ngrid.draw(table)
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- lindqvist_list/newversion/lindqvist20.r	(revision b9eda22f2c445e7b5804430a59263cf548c7f211)
+++ lindqvist_list/newversion/lindqvist20.r	(date 1599646457835)
@@ -1,27 +1,27 @@
 #############################
 # Input Parameters
 #############################
-sims = 250#The number of simulations of script mgQMRA 
+sims = 50#The number of simulations of script mgQMRA 
 pop=11 #11 is females and 12 is males, age group 65-74 years old
-runs= 200000 #Define the number of iterations to run the script
+runs= 100000 #Define the number of iterations to run the script
 
 #############################
 # Model Script
 #############################
 ###########################################
 #Libraries used in the script
-library(readr)
-library(readxl)
-library(msm)
-library(tidyverse)
-library(plotly)
-library(mc2d)
-library(knitr)
-library(ggplot2)
-library(readr)
-library(dplyr)
-library(xlsx)
-library(Matrix)
+# library(readr)
+# library(readxl)
+# library(msm)
+# library(tidyverse)
+# library(plotly)
+# library(mc2d)
+# library(knitr)
+# library(ggplot2)
+# library(readr)
+# library(dplyr)
+# library(xlsx)
+# library(Matrix)
 
 set.seed(3333) #Arbitrary number but should be set so differences are due only to differencs in input data
 
@@ -46,7 +46,7 @@
   #################################################
   #Extract input data to xfile
   #################################################
-  xfile="~/Projects/ModelRepository/lindqvist_list/originalfiles/input.data.xlsx"
+  xfile="~/PycharmProjects/ModelRepository/lindqvist_list/originalfiles/input.data.xlsx"
   prev=read_excel(xfile,sheet="prev", col_names=TRUE)
   conc=read_excel(xfile,sheet="conc", col_names=TRUE)
   EGR=read_excel(xfile,sheet="EGR", col_names=TRUE)
